# Lui-XML CI/CD Pipeline
# Continuous integration for multiple platforms and build systems

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  # Cache LVGL for faster builds
  LVGL_VERSION: "v9.5"

jobs:
  #############################################################################
  # Linux x86_64 - GCC
  #############################################################################
  linux-gcc:
    name: Linux GCC
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          gcc \
          cmake \
          git

    - name: Cache LVGL
      id: cache-lvgl
      uses: actions/cache@v4
      with:
        path: lvgl
        key: lvgl-${{ env.LVGL_VERSION }}-gcc

    - name: Clone LVGL
      if: steps.cache-lvgl.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch ${LVGL_VERSION} https://github.com/lvgl/lvgl.git

    - name: Configure LVGL
      run: |
        cd lvgl
        cmake -B build -DLV_CONF_PATH=${GITHUB_WORKSPACE}/tests/ci/lv_conf.h \
              -DCMAKE_INSTALL_PREFIX=${HOME}/lvgl-install
        cmake --build build
        sudo cmake --install build

    - name: Configure Lui-XML
      run: |
        cmake -B build -DLVGL_DIR=${HOME}/lvgl-install

    - name: Build Lui-XML
      run: |
        cmake --build build

    - name: Static Analysis
      run: |
        cmake --build build -- clean-first
        cmake --build build -- CMAKE_C_FLAGS="-Werror -Wall -Wextra -Wpedantic"

    - name: Namespace Check
      run: |
        if grep -r "lv_xml_" src/; then
          echo "ERROR: Forbidden lv_xml_ symbols found!"
          exit 1
        fi
        echo "Namespace check passed: No lv_xml_ symbols found"

  #############################################################################
  # Linux x86_64 - Clang
  #############################################################################
  linux-clang:
    name: Linux Clang
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          cmake \
          git

    - name: Cache LVGL
      id: cache-lvgl
      uses: actions/cache@v4
      with:
        path: lvgl
        key: lvgl-${{ env.LVGL_VERSION }}-clang

    - name: Clone LVGL
      if: steps.cache-lvgl.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch ${LVGL_VERSION} https://github.com/lvgl/lvgl.git

    - name: Configure LVGL (Clang)
      run: |
        cd lvgl
        CC=clang CXX=clang++ cmake -B build \
              -DLV_CONF_PATH=${GITHUB_WORKSPACE}/tests/ci/lv_conf.h \
              -DCMAKE_INSTALL_PREFIX=${HOME}/lvgl-install
        cmake --build build
        sudo cmake --install build

    - name: Configure Lui-XML (Clang)
      run: |
        CC=clang CXX=clang++ cmake -B build -DLVGL_DIR=${HOME}/lvgl-install

    - name: Build Lui-XML (Clang)
      run: |
        cmake --build build

    - name: Static Analysis (Clang)
      run: |
        cmake --build build -- clean-first
        cmake --build build -- CMAKE_C_FLAGS="-Werror -Wall -Wextra"

  #############################################################################
  # ESP-IDF v5.1
  #############################################################################
  esp-idf-v5.1:
    name: ESP-IDF v5.1
    runs-on: ubuntu-latest
    container: espressif/idf:v5.1

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Verify ESP-IDF Environment
      run: |
        idf.py --version
        echo "ESP_IDF_VERSION=$IDF_VERSION" >> $GITHUB_ENV

    - name: Create Test Project
      run: |
        mkdir -p test_project
        cd test_project
        idf.py create-project --path . --based-on esp32

    - name: Add Lui-XML Component
      run: |
        mkdir -p test_project/components
        cp -r $GITHUB_WORKSPACE test_project/components/lui_xml

    - name: Add LVGL Dependency
      run: |
        cd test_project/main
        echo 'espressif/esp_lvgl_port' >> test_project/main/idf_component.yml

    - name: Configure Test Project
      run: |
        cd test_project
        idf.py set-target esp32
        idf.py reconfigure

    - name: Build Test Project
      run: |
        cd test_project
        idf.py build

  #############################################################################
  # ESP-IDF v5.2
  #############################################################################
  esp-idf-v5.2:
    name: ESP-IDF v5.2
    runs-on: ubuntu-latest
    container: espressif/idf:v5.2

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Verify ESP-IDF Environment
      run: |
        idf.py --version
        echo "ESP_IDF_VERSION=$IDF_VERSION" >> $GITHUB_ENV

    - name: Create Test Project
      run: |
        mkdir -p test_project
        cd test_project
        idf.py create-project --path . --based-on esp32

    - name: Add Lui-XML Component
      run: |
        mkdir -p test_project/components
        cp -r $GITHUB_WORKSPACE test_project/components/lui_xml

    - name: Add LVGL Dependency
      run: |
        cd test_project/main
        echo 'espressif/esp_lvgl_port' >> test_project/main/idf_component.yml

    - name: Configure Test Project
      run: |
        cd test_project
        idf.py set-target esp32s3
        idf.py reconfigure

    - name: Build Test Project
      run: |
        cd test_project
        idf.py build

  #############################################################################
  # Zephyr RTOS - native_sim
  #############################################################################
  zephyr-native_sim:
    name: Zephyr RTOS (native_sim)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Install Zephyr Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          gperf \
          ccache \
          dfu-util \
          device-tree-compiler \
          wget \
          xz-utils \
          file \
          make \
          gcc \
          gcc-multilib \
          zstd \
          liblzma-dev \
          libpython3-dev \
          libssl-dev \
          libtinfo5 \
          apt-file

    - name: Install West Tool
      run: |
        pip3 install west

    - name: Initialize Zephy Workspace
      run: |
        west init -m https://github.com/zephyrproject-rtos/zephyr --mr v3.5.0 zephyrworkspace
        cd zephyrworkspace
        west update
        west zephyr-export

    - name: Setup Zephyr Environment
      run: |
        source zephyrworkspace/zephyr/zephyr-env.sh

    - name: Create Test Application
      run: |
        mkdir -p zephyr_test
        cd zephyr_test
        cat > CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.20)
        find_package(Zephyr REQUIRED HINTS $ENV{ZEPHYR_BASE})
        project(zephyr_test)
        target_sources(app PRIVATE src/main.c)
        EOF

        mkdir -p src
        cat > src/main.c << 'EOF'
        #include <zephyr/kernel.h>
        int main(void) {
            printk("Lui-XML Zephyr test\n");
            return 0;
        }
        EOF

    - name: Build for native_sim
      run: |
        source zephyrworkspace/zephyr/zephyr-env.sh
        cd zephyr_test
        west build -b native_sim

  #############################################################################
  # Namespace Compliance Check
  #############################################################################
  namespace-check:
    name: Namespace Compliance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Lui-XML
      uses: actions/checkout@v4

    - name: Check for Forbidden lv_xml_ Symbols
      run: |
        echo "Checking for forbidden lv_xml_ symbols..."
        if grep -r "lv_xml_" src/ 2>/dev/null; then
          echo "::error::Forbidden lv_xml_ symbols found in source code!"
          exit 1
        fi
        echo "✓ No lv_xml_ symbols found"

    - name: Check for Required lui_xml_ Symbols
      run: |
        echo "Checking for required lui_xml_ symbols..."
        if ! grep -r "lui_xml_" src/xml/ 2>/dev/null | head -5; then
          echo "::warning::No lui_xml_ symbols found (expected in public API)"
        fi
        echo "✓ lui_xml_ symbols present"

    - name: Check for Internal luixml_ Symbols
      run: |
        echo "Checking for internal luixml_ symbols..."
        if ! grep -r "luixml_" src/ 2>/dev/null | head -5; then
          echo "::warning::No luixml_ symbols found (expected in compat layer)"
        fi
        echo "✓ luixml_ symbols present"

    - name: Verify No Private Headers
      run: |
        echo "Checking for LVGL private header includes..."
        if grep -r "lvgl/src/" src/ 2>/dev/null; then
          echo "::error::LVGL private headers included!"
          exit 1
        fi
        if grep -r "lvgl_private" src/ 2>/dev/null; then
          echo "::error::lvgl_private.h included!"
          exit 1
        fi
        echo "✓ No private headers included"

  #############################################################################
  # Build System Summary
  #############################################################################
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [linux-gcc, linux-clang, esp-idf-v5.1, esp-idf-v5.2, zephyr-native_sim, namespace-check]
    if: always()

    steps:
    - name: Generate Summary
      run: |
        echo "## Lui-XML CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linux GCC | ${{ needs.linux-gcc.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux Clang | ${{ needs.linux-clang.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ESP-IDF v5.1 | ${{ needs.esp-idf-v5.1.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ESP-IDF v5.2 | ${{ needs.esp-idf-v5.2.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Zephyr native_sim | ${{ needs.zephyr-native_sim.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Namespace Check | ${{ needs.namespace-check.result }} |" >> $GITHUB_STEP_SUMMARY
